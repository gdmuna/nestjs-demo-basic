name: Auto Tag Release

on:
  pull_request:
    types: [closed]
    branches: [main]

permissions:
  contents: write

concurrency:
  group: auto-tag-release-${{ github.event.pull_request.base.ref }}
  cancel-in-progress: false

jobs:
  auto-tag:
    name: Auto tag from release branch
    if: github.event.pull_request.merged == true && startsWith(github.event.pull_request.head.ref, 'release-')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0 # èŽ·å–å®Œæ•´åŽ†å²ä»¥æŸ¥æ‰¾æ‰€æœ‰tag

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Extract version from package.json
        id: version
        run: |
          VERSION=$(node -e "console.log(require('./package.json').version)")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Application Version: $VERSION"

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          # é…ç½® Git å‡­è¯ï¼ˆé¿å…è®¤è¯é—®é¢˜ï¼‰
          git config --global credential.helper store
          echo "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com" > ~/.git-credentials

      - name: Create release tag
        id: create_tag
        env:
          RELEASE_BRANCH: ${{ github.event.pull_request.head.ref }}
        run: node scripts/create-release-tag.cjs "$RELEASE_BRANCH"
        continue-on-error: true

      - name: Push tag (with conflict detection)
        if: steps.create_tag.outputs.version_valid == 'true'
        id: push_tag
        run: |
          TAG_NAME="${{ steps.create_tag.outputs.new_tag }}"

          # åˆ·æ–° tag åˆ—è¡¨ï¼Œæ£€æµ‹å¹¶å‘æŽ¨é€
          git fetch origin --tags 2>&1 || true

          # æ£€æŸ¥ tag æ˜¯å¦å·²åœ¨è¿œç«¯ï¼ˆå¹¶å‘åœºæ™¯ï¼‰
          if git ls-remote origin "refs/tags/${TAG_NAME}" | grep -q "${TAG_NAME}"; then
            echo "âš ï¸ Tag ${TAG_NAME} already pushed by another workflow"
            echo "âœ… Concurrent execution handled gracefully"
            COMMIT_SHA=$(git rev-list -n 1 "${TAG_NAME}" | cut -c1-7)
            echo "commit_sha=${COMMIT_SHA}" >> $GITHUB_OUTPUT
            exit 0
          fi

          # æŽ¨é€ tag
          if git push origin "${TAG_NAME}" 2>&1; then
            echo "âœ… Tag ${TAG_NAME} pushed successfully"
            # èŽ·å– tag æŒ‡å‘çš„ commit SHAï¼ˆ7ä½çŸ­å“ˆå¸Œï¼‰
            COMMIT_SHA=$(git rev-list -n 1 "${TAG_NAME}" | cut -c1-7)
            echo "commit_sha=${COMMIT_SHA}" >> $GITHUB_OUTPUT
          else
            # æŽ¨é€å¤±è´¥ï¼Œé‡æ–°æ£€æŸ¥æ˜¯å¦è¢«å…¶ä»–å·¥ä½œæµæŽ¨é€äº†
            git fetch origin --tags
            if git ls-remote origin "refs/tags/${TAG_NAME}" | grep -q "${TAG_NAME}"; then
              echo "âœ… Tag was pushed by concurrent workflow"
              COMMIT_SHA=$(git rev-list -n 1 "${TAG_NAME}" | cut -c1-7)
              echo "commit_sha=${COMMIT_SHA}" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "âŒ Failed to push tag and tag not found remotely"
              exit 1
            fi
          fi

      - name: Generate summary
        if: always() && github.event.pull_request.merged == true && startsWith(github.event.pull_request.head.ref, 'release-')
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_HEAD_REPO: ${{ github.event.pull_request.head.repo.full_name }}
          PR_HEAD_REF: ${{ github.event.pull_request.head.ref }}
        run: |
          # è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦ï¼Œé˜²æ­¢ç ´å Markdown
          PR_TITLE_ESCAPED="${PR_TITLE//$'\n'/ }"
          PR_TITLE_ESCAPED="${PR_TITLE_ESCAPED//\`/\\\`}"
          PR_HEAD_REPO_ESCAPED="${PR_HEAD_REPO//\`/\\\`}"
          PR_HEAD_REF_ESCAPED="${PR_HEAD_REF//\`/\\\`}"

          # æ£€æŸ¥ç‰ˆæœ¬éªŒè¯çŠ¶æ€
          VERSION_VALID="${{ steps.create_tag.outputs.version_valid }}"

          if [ "$VERSION_VALID" != "true" ]; then
            # ç‰ˆæœ¬éªŒè¯å¤±è´¥çš„ summary
            cat >> $GITHUB_STEP_SUMMARY << EOF
          # ðŸ·ï¸ Auto Tag Release - âŒ Skipped
          ## âš ï¸ ç‰ˆæœ¬éªŒè¯å¤±è´¥
          æ­¤å·¥ä½œæµå›  package.json ç‰ˆæœ¬ä¸ç¬¦åˆè¦æ±‚è€Œè¢«è·³è¿‡ã€‚

          ## ðŸ“‹ åŸºæœ¬ä¿¡æ¯
          - **è§¦å‘äº‹ä»¶**: pull_request
          - **ä»£ç ä»“åº“**: [${{ github.repository }}](${{ github.server_url }}/${{ github.repository }})
          - **PR**: [#${{ github.event.pull_request.number }} - ${PR_TITLE_ESCAPED}](${{ github.event.pull_request.html_url }})
          - **æºåˆ†æ”¯ â†’ ç›®æ ‡åˆ†æ”¯**: [${PR_HEAD_REPO_ESCAPED}/${PR_HEAD_REF_ESCAPED} â†’ ${{ github.base_ref }}](${{ github.event.pull_request.html_url }}/changes)

          ## âŒ ç‰ˆæœ¬æ£€æŸ¥ç»“æžœ
          - **æœŸæœ›ç‰ˆæœ¬**: \`${{ steps.create_tag.outputs.expected_version }}\`
          - **å®žé™…ç‰ˆæœ¬**: \`${{ steps.create_tag.outputs.actual_version }}\`
          - **çŠ¶æ€**: âŒ ä¸åŒ¹é…

          ## ðŸ’¡ è§£å†³æ–¹æ³•
          1. åœ¨ release PR ä¸­æ›´æ–° \`package.json\` çš„ \`version\` å­—æ®µä¸º \`${{ steps.create_tag.outputs.expected_version }}\`
          2. æäº¤å¹¶æŽ¨é€æ›´æ”¹
          3. PR æ£€æŸ¥ä¼šè‡ªåŠ¨é‡æ–°è¿è¡Œ

          ## â° æ—¶é—´æˆ³
          - **å®Œæˆæ—¶é—´ (UTC)**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - **å®Œæˆæ—¶é—´ (Asia/Shanghai)**: $(TZ='Asia/Shanghai' date +"%Y-%m-%d %H:%M:%S %Z")
          EOF
          else
            # æ­£å¸¸æ‰§è¡Œçš„ summary
            cat >> $GITHUB_STEP_SUMMARY << EOF
          # ðŸ·ï¸ Auto Tag Release
          ## ðŸ“‹ åŸºæœ¬ä¿¡æ¯
          - **è§¦å‘äº‹ä»¶**: pull_request
          - **ä»£ç ä»“åº“**: [${{ github.repository }}](${{ github.server_url }}/${{ github.repository }})
          - **PR**: [#${{ github.event.pull_request.number }} - ${PR_TITLE_ESCAPED}](${{ github.event.pull_request.html_url }})
          - **æºåˆ†æ”¯ â†’ ç›®æ ‡åˆ†æ”¯**: [${{ github.event.pull_request.head.repo.full_name }}/${PR_HEAD_REF_ESCAPED} â†’ ${{ github.base_ref }}](${{ github.event.pull_request.html_url }}/changes)
          - **æäº¤å“ˆå¸Œ**: [${GITHUB_SHA:0:7}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
          ## ðŸ“¦ Package version
          - **æºç‰ˆæœ¬ â†’ æ–°ç‰ˆæœ¬**: ${{ steps.version.outputs.version }} â†’ ${{ steps.create_tag.outputs.new_version }}
          - **æäº¤å“ˆå¸Œ**: [${{ steps.push_tag.outputs.commit_sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ steps.push_tag.outputs.commit_sha }})
          ## ðŸ·ï¸ åˆ›å»ºçš„æ ‡ç­¾
          - **Tag**: [${{ steps.create_tag.outputs.new_tag }}](${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ steps.create_tag.outputs.new_tag }})
          ## â° æ—¶é—´æˆ³
          - **å®Œæˆæ—¶é—´ (UTC)**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - **å®Œæˆæ—¶é—´ (Asia/Shanghai)**: $(TZ='Asia/Shanghai' date +"%Y-%m-%d %H:%M:%S %Z")
          EOF
          fi

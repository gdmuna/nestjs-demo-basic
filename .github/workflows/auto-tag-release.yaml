name: Auto Tag Release

on:
  pull_request:
    types: [closed]
    branches: [main]

permissions:
  contents: write

jobs:
  auto-tag:
    name: Auto tag from release branch
    if: github.event.pull_request.merged == true && startsWith(github.event.pull_request.head.ref, 'release-')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0 # èŽ·å–å®Œæ•´åŽ†å²ä»¥æŸ¥æ‰¾æ‰€æœ‰tag

      - name: Extract version from package.json
        id: version
        run: |
          VERSION=$(node -e "console.log(require('./package.json').version)")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Application Version: $VERSION"

      - name: Extract version and create tag
        run: |
          # æå–releaseåˆ†æ”¯åï¼ˆä¾‹å¦‚ï¼šrelease-1.12 â†’ 1.12ï¼‰
          RELEASE_BRANCH="${{ github.event.pull_request.head.ref }}"
          VERSION_PREFIX=$(echo "$RELEASE_BRANCH" | sed 's/release-//')

          echo "=========================================="
          echo "ðŸ“¦ Release Branch: $RELEASE_BRANCH"
          echo "ðŸ“Œ Version Prefix: $VERSION_PREFIX"
          echo "=========================================="

          # æŸ¥æ‰¾å·²æœ‰çš„è¯¥ç‰ˆæœ¬ç³»åˆ—çš„æ‰€æœ‰tagï¼ˆæŽ’é™¤å¿«ç…§tagï¼ŒåªåŒ¹é… v1.12.0 æ ¼å¼ï¼‰
          EXISTING_TAGS=$(git tag -l "v${VERSION_PREFIX}.*" | grep -E "^v${VERSION_PREFIX}\.[0-9]+$" | sort -V)

          if [ -z "$EXISTING_TAGS" ]; then
            # ç¬¬ä¸€æ¬¡åˆå¹¶ï¼Œpatchä¸º0
            PATCH=0
            echo "ðŸ†• First merge from this release branch"
          else
            # æ‰¾å‡ºæœ€å¤§çš„patchå·
            LATEST_TAG=$(echo "$EXISTING_TAGS" | tail -n 1)
            LATEST_PATCH=$(echo "$LATEST_TAG" | sed "s/v${VERSION_PREFIX}\.//" )
            PATCH=$((LATEST_PATCH + 1))
            echo "ðŸ“ˆ Latest tag: $LATEST_TAG"
            echo "ðŸ“ˆ Next patch: $PATCH"
          fi

          NEW_TAG="v${VERSION_PREFIX}.${PATCH}"
          NEW_VERSION="${VERSION_PREFIX}.${PATCH}"

          echo "=========================================="
          echo "ðŸ·ï¸  New Tag: $NEW_TAG"
          echo "ðŸ“¦ New Version: $NEW_VERSION"
          echo "=========================================="

          # ä¿å­˜åˆ°çŽ¯å¢ƒå˜é‡ä¾›åŽç»­æ­¥éª¤ä½¿ç”¨
          echo "NEW_TAG=$NEW_TAG" >> $GITHUB_ENV
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV

      - name: Update package.json version
        run: |
          # æ›´æ–°package.jsonä¸­çš„versionå­—æ®µ
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            pkg.version = '$NEW_VERSION';
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
          "
          echo "ðŸ“ Updated package.json version to $NEW_VERSION"

      - name: Commit and push version update
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add package.json
          git commit -m "chore(release): bump version to $NEW_VERSION [skip ci]"
          git push origin main

          echo "âœ… Version update committed and pushed to main"

      - name: Create and push tag
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # åœ¨æœ€æ–°çš„commitä¸Šåˆ›å»ºtagï¼ˆåŒ…å«versionæ›´æ–°ï¼‰
          git tag "$NEW_TAG"
          git push origin "$NEW_TAG"

          echo "âœ… Tag $NEW_TAG created and pushed successfully"

      - name: Generate summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ðŸ·ï¸ Auto Tag Release
          ## ðŸ“‹ åŸºæœ¬ä¿¡æ¯
          - **è§¦å‘äº‹ä»¶**: pull_request
          - **ä»£ç ä»“åº“**: [${{ github.repository }}](${{ github.server_url }}/${{ github.repository }})
          - **PR**: [#${{ github.event.pull_request.number }} - ${{ github.event.pull_request.title }}](${{ github.event.pull_request.html_url }})
          - **æºåˆ†æ”¯ â†’ ç›®æ ‡åˆ†æ”¯**: [${{ github.event.pull_request.head.repo.full_name }}/${{ github.event.pull_request.head.ref }} â†’ ${{ github.base_ref }}](${{ github.event.pull_request.html_url }}/changes)
          - **æäº¤å“ˆå¸Œ**: [${GITHUB_SHA:0:7}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
          - **åº”ç”¨ç‰ˆæœ¬**: ${{ steps.version.outputs.version }}
          ## ðŸ·ï¸ åˆ›å»ºçš„æ ‡ç­¾
          - **Tag**: [$NEW_TAG](${{ github.server_url }}/${{ github.repository }}/releases/tag/$NEW_TAG)
          ## â° æ—¶é—´æˆ³
          - **å®Œæˆæ—¶é—´ (UTC)**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - **å®Œæˆæ—¶é—´ (Asia/Shanghai)**: $(TZ='Asia/Shanghai' date +"%Y-%m-%d %H:%M:%S %Z")
          EOF

name: CI/CD Pipeline

on:
  push:
    branches: [main]
  # pull_request:
  #   branches: [main]

jobs:
  lint-test-build-publish:
    runs-on: ubuntu-latest
    env:
      DOCKER_USERNAME: ${{ vars.DOCKER_USERNAME || github.repository_owner }}
      DOCKER_REPO_NAME: ${{ vars.DOCKER_REPO_NAME || github.event.repository.name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Use Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: |
          echo "ðŸ“¥ å®‰è£…é¡¹ç›®ä¾èµ–"
          pnpm install
          echo "âœ“ ä¾èµ–å®‰è£…å®Œæˆ"

      - name: Generate Prisma Client
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: pnpm prisma generate

      - name: Format & Lint code
        run: |
          echo "ðŸ“ æ ¼å¼åŒ–ä»£ç "
          pnpm prettier --write .
          echo "âœ“ æ ¼å¼åŒ–å®Œæˆ"
          echo "âœ… è´¨é‡æ£€æŸ¥"
          pnpm eslint --fix
          echo "âœ“ è´¨é‡æ£€æŸ¥å®Œæˆ"

      - name: Run tests with coverage
        run: |
          echo "ðŸ§ª è¿è¡Œæµ‹è¯•"
          pnpm test --ci --coverage
          echo "âœ“ æµ‹è¯•å®Œæˆ"

      # - name: Publish test results
      #   uses: dorny/test-reporter@v1
      #   if: always()
      #   with:
      #     name: Jest Test Results
      #     path: coverage/test-results.json
      #     reporter: jest-junit

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_REPO_NAME }}:latest
            ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_REPO_NAME }}:${{ github.ref_name }}-${{ github.sha }}
            ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_REPO_NAME }}:${{ github.run_number }}
          # æž„å»ºæ—¶ä¼ å…¥çŽ¯å¢ƒå˜é‡
          build-args: |
            DATABASE_URL=${{ secrets.DATABASE_URL }}

      - name: Generate Summary
        run: |
          TIMESTAMP_UTC=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          TIMESTAMP_CN=$(TZ='Asia/Shanghai' date +"%Y-%m-%d %H:%M:%S %Z")
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸš€ CI/CD Pipeline Summary

          ### âœ… æž„å»ºä¿¡æ¯
          - **ä»£ç ä»“åº“**: [GitHub/${{ github.repository }}](${{ github.server_url }}/${{ github.repository }})
          - **é•œåƒä»“åº“** : [Docker Hub/$DOCKER_USERNAME/$DOCKER_REPO_NAME](https://hub.docker.com/repository/docker/$DOCKER_USERNAME/$DOCKER_REPO_NAME)
          - **æ‰€å±žåˆ†æ”¯**: ${{ github.ref_name }}
          - **æäº¤å“ˆå¸Œ**: ${{ github.sha }}
          - **è¿è¡Œå·**: ${{ github.run_number }}

          ### ðŸ“¦ Docker é•œåƒ
          - $DOCKER_USERNAME/$DOCKER_REPO_NAME:latest
          - $DOCKER_USERNAME/$DOCKER_REPO_NAME:${{ github.ref_name }}-${{ github.sha }}
          - $DOCKER_USERNAME/$DOCKER_REPO_NAME:${{ github.run_number }}

          ### â° æ—¶é—´æˆ³
          - å®Œæˆæ—¶é—´ (UTC): $TIMESTAMP_UTC
          - å®Œæˆæ—¶é—´ (China/Asia/Shanghai): $TIMESTAMP_CN
          EOF
